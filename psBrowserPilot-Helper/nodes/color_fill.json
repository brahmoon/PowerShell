{
  "id": "color_fill",
  "label": "Color Fill",
  "category": "Custom",
  "execution": "ui",
  "inputs": [
    "Color",
    "Sheet",
    "Range"
  ],
  "outputs": [],
  "constants": [
    {
      "key": "note",
      "type": "TextBox",
      "value": "# TODO: describe behavior"
    }
  ],
  "script": "# Use {{input.Name}} to reference incoming values,\n# {{config.key}} for constant fields, and {{output.Result}} for outputs.\n# Remove these lines and write your PowerShell snippet here.",
  "ui": {
    "markup": "<div class=\"excel-ui-node color-palette-node\" data-role=\"root\">\n  <div class=\"palette-header\">\n    <div class=\"palette-title\">Color Palette</div>\n    <div class=\"palette-status\" data-role=\"status\"></div>\n  </div>\n\n  <div class=\"palette-frame\">\n    <div class=\"palette-grid\" data-role=\"grid\">\n      <!-- SVGボタンたちがここに挿入される（+ボタンの左に追加） -->\n      <button type=\"button\" class=\"palette-add\" data-role=\"add\" aria-label=\"Add color\">\n        <span class=\"plus-icon\">＋</span>\n      </button>\n    </div>\n  </div>\n</div>\n",
    "script": "const {\n  node,\n  controls,\n  updateConfig,\n  resolveInput,\n  ensureAutoNodes,\n  toPowerShellLiteral,\n  helpers,\n} = context;\nif (!controls) return;\n\nconst grid = controls.querySelector('[data-role=\"grid\"]');\nconst addButton = controls.querySelector('[data-role=\"add\"]');\nconst statusEl = controls.querySelector('[data-role=\"status\"]');\nif (!grid || !addButton || !statusEl) {\n  helpers?.NodeLogger?.warn?.('[color_fill] Required UI elements are missing.');\n  return;\n}\n\nconst logger = helpers?.NodeLogger || console;\nconst status = helpers?.NodeUI?.bindStatus(statusEl);\nconst palette = helpers?.PaletteUI?.create({\n  grid,\n  addButton,\n  root: controls,\n  storage: helpers?.StorageHelper,\n  storageKey: 'colorPalette',\n  onApply: ({ hex, ole }) => applyColor(hex, ole),\n});\nconst colorHelper = helpers?.ColorHelper;\nconst excelHelper = helpers?.ExcelHelper;\nconst bridge = helpers?.NodeBridge;\n\nconst buildColorApplyScript = (rangeSpec, colorInt) => {\n  const { addressLiteral, workbookLiteral, sheetLiteral } = rangeSpec || {};\n  const useAddress = Boolean(addressLiteral);\n  const useWorkbook = Boolean(workbookLiteral);\n  const useSheet = Boolean(sheetLiteral);\n  const lines = [\n    \"$ErrorActionPreference = 'Stop'\",\n    'Add-Type -AssemblyName System.Drawing',\n    helpers?.ColorHelper?.COLOR_HELPERS_SCRIPT || '',\n    \"$excel = $null; $workbook = $null; $sheet = $null; $target = $null;\",\n    'try {',\n    \"  $excel = [Runtime.Interopservices.Marshal]::GetActiveObject('Excel.Application')\",\n    \"  if ($null -eq $excel) { throw 'Excel が見つかりません。' }\",\n  ];\n  if (useWorkbook) {\n    lines.push(\n      \"  foreach ($wb in @($excel.Workbooks)) { if ($null -ne $wb -and $wb.Name -eq \" + workbookLiteral + \") { $workbook = $wb; break } }\",\n      \"  if ($null -eq $workbook) { throw (\\\"Workbook not found: {0}\\\" -f \" + workbookLiteral + \") }\"\n    );\n  } else {\n    lines.push('  $workbook = $excel.ActiveWorkbook');\n  }\n  lines.push('  if ($null -eq $workbook) { $workbook = $excel.ActiveWorkbook }');\n  if (useSheet) {\n    lines.push(\n      \"  if ($workbook -ne $null) { foreach ($ws in @($workbook.Worksheets)) { if ($null -ne $ws -and $ws.Name -eq \" + sheetLiteral + \") { $sheet = $ws; break } } }\",\n      \"  if ($null -eq $sheet) { throw (\\\"Worksheet not found: {0}\\\" -f \" + sheetLiteral + \") }\"\n    );\n  } else {\n    lines.push('  if ($workbook -ne $null) { $sheet = $workbook.ActiveSheet }');\n  }\n  lines.push(\"  if ($sheet -eq $null) { try { $sheet = $excel.ActiveSheet } catch { $sheet = $null } }\");\n  if (useAddress) {\n    lines.push(\n      \"  if ($sheet -ne $null) { try { $target = $sheet.Range(\" + addressLiteral + \") } catch { $target = $null } }\",\n      \"  if ($target -eq $null) { try { $target = $excel.Range(\" + addressLiteral + \") } catch { $target = $null } }\"\n    );\n  }\n  lines.push(\n    \"  if ($target -eq $null) { $target = $excel.Selection }\",\n    \"  if ($null -eq $target) { throw '範囲が取得できません。' }\",\n    `  $target.Interior.Color = ${colorInt}`,\n    '  $result = [pscustomobject]@{',\n    '    ok = $true;',\n    '    workbook = try { $workbook?.Name } catch { $null };',\n    '    sheet = try { $sheet?.Name } catch { $null };',\n    '    address = try { $target.Address() } catch { $null };',\n    '    interior_color = @{ hex = Convert-OleToHex $target.Interior.Color; ole = $target.Interior.Color }',\n    '  }',\n    '} catch {',\n    \"  $result = [pscustomobject]@{ ok = $false; error = $_.Exception.Message }\",\n    '} finally {',\n    \"  if ($target -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($target) | Out-Null }\",\n    \"  if ($sheet -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheet) | Out-Null }\",\n    \"  if ($workbook -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null }\",\n    \"  if ($excel -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null }\",\n    '  [GC]::Collect(); [GC]::WaitForPendingFinalizers()',\n    '}',\n    '$result | ConvertTo-Json -Compress',\n  );\n  return lines.filter(Boolean).join('\\n');\n};\n\nconst resolvePortValue = async (name) => {\n  if (typeof ensureAutoNodes === 'function') {\n    try {\n      await ensureAutoNodes([name]);\n    } catch (error) {\n      logger?.warn?.(`[color_fill] Failed to auto-update input ${name}`, error);\n    }\n  }\n  if (typeof resolveInput === 'function') {\n    try {\n      const raw = resolveInput(name, { preferRaw: true });\n      if (raw !== undefined && raw !== null && String(raw).trim()) {\n        return raw;\n      }\n      const value = resolveInput(name);\n      if (value !== undefined && value !== null && String(value).trim()) {\n        return value;\n      }\n    } catch (error) {\n      logger?.warn?.(`[color_fill] Failed to resolve input ${name}`, error);\n    }\n  }\n  const rawKey = `${name}__raw`;\n  if (node?.config?.[rawKey]) {\n    return node.config[rawKey];\n  }\n  if (node?.config?.[name]) {\n    return node.config[name];\n  }\n  return '';\n};\n\nconst applyColor = async (hex, ole) => {\n  if (!bridge?.requestJson) {\n    status?.set?.('PowerShell 連携が利用できません。', 'error');\n    return;\n  }\n  status?.set?.(`${hex} を適用中…`, 'pending');\n  try {\n    const rangeSource = await resolvePortValue('Range');\n    const rangeInfo = excelHelper?.parseRangeInfo?.(rangeSource) || {};\n    const sheetSource = await resolvePortValue('Sheet');\n    const sheetInfo = excelHelper?.parseSheetInfo?.(sheetSource) || {};\n    if (!rangeInfo.workbook && sheetInfo.workbook) rangeInfo.workbook = sheetInfo.workbook;\n    if (!rangeInfo.sheet && sheetInfo.sheet) rangeInfo.sheet = sheetInfo.sheet;\n    const rangeSpec = excelHelper?.createRangeSpec?.(rangeInfo, toPowerShellLiteral) || {};\n    const script = buildColorApplyScript(rangeSpec, ole);\n    const result = await bridge.requestJson(script);\n    if (!result?.ok) {\n      throw new Error(result?.error || 'PowerShell 実行に失敗しました。');\n    }\n    const label = [result.workbook, result.sheet, result.address].filter(Boolean).join(' ');\n    status?.set?.(`${label || '選択範囲'} に色を適用しました。`, 'success');\n  } catch (error) {\n    status?.set?.(`着色に失敗: ${error.message}`, 'error');\n    logger?.error?.('[color_fill] Failed to apply color', error);\n  }\n};\n\nconst addColorsFromValue = (rawValue, { replace = false } = {}) => {\n  if (!colorHelper?.parse) {\n    status?.set?.('ColorHelper が利用できません。', 'error');\n    return { added: 0, total: 0 };\n  }\n  if (rawValue === undefined || rawValue === null) {\n    return { added: 0, total: 0 };\n  }\n  const text = typeof rawValue === 'string' ? rawValue.trim() : rawValue;\n  if (!text) {\n    return { added: 0, total: 0 };\n  }\n  try {\n    const colors = colorHelper.parse(text);\n    const { added, total } = palette.addColors(colors, { replace });\n    if (added) {\n      status?.set?.(\n        replace ? `${added} 色をロードしました。` : `${added} 色を追加しました。`,\n        replace ? 'info' : 'success'\n      );\n    } else if (total) {\n      status?.set?.('すべて既に追加済みの色です。', 'info');\n    }\n    return { added, total };\n  } catch (error) {\n    status?.set?.(`Color の解釈に失敗: ${error.message}`, 'error');\n    logger?.error?.('[color_fill] Failed to parse colors', error);\n    return { added: 0, total: 0 };\n  }\n};\n\nconst restored = palette?.load?.({ replace: true }) || { added: 0, total: 0 };\nif (restored.added) {\n  status?.set?.(`${restored.added} 色を復元しました。`, 'info');\n}\n\nconst initializeFromInput = async () => {\n  const colorSource = await resolvePortValue('Color');\n  if (!colorSource && !restored.added) {\n    addColorsFromValue('#FF0000', { replace: false });\n    status?.set?.('Color ポートが未指定のため #FF0000 を追加しました。', 'info');\n    return;\n  }\n  if (colorSource) {\n    addColorsFromValue(colorSource, { replace: !restored.added });\n  }\n};\n\naddButton.addEventListener('click', async (event) => {\n  event.preventDefault();\n  const colorSource = await resolvePortValue('Color');\n  if (!colorSource) {\n    status?.set?.('Color ポートに色を指定してください。', 'info');\n    return;\n  }\n  addColorsFromValue(colorSource, { replace: false });\n});\n\ninitializeFromInput();\n\nreturn () => {\n  palette?.dispose?.();\n  status?.dispose?.();\n};",
    "style": ".color-palette-node {\n  font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Noto Sans JP\", Arial, sans-serif;\n  display: grid;\n  gap: 8px;\n  position: relative;\n}\n\n.palette-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n\n.palette-title {\n  font-weight: 600;\n}\n\n.palette-status[data-state=\"error\"] { color: #b00020; }\n.palette-status[data-state=\"success\"] { color: #137333; }\n.palette-status[data-state=\"pending\"] { color: #1a73e8; }\n.palette-status[data-state=\"info\"] { color: #5f6368; }\n\n.palette-frame {\n  border: 1px solid #e0e3e7;\n  border-radius: 12px; /* 角R */\n  padding: 10px;\n  background: #fff;\n}\n\n.palette-grid {\n  display: grid;\n  grid-template-columns: repeat(6, 56px); /* 6列 */\n  gap: 8px;\n  align-items: start;\n}\n\n.palette-add {\n  width: 56px;\n  height: 56px;\n  border: 1px dashed #9aa0a6;\n  border-radius: 12px;\n  background: #f8f9fa;\n  cursor: pointer;\n  display: inline-grid;\n  place-items: center;\n}\n\n.palette-add:hover { background: #f1f3f4; }\n.plus-icon { font-size: 20px; line-height: 1; }\n\n.palette-swatch {\n  width: 56px;\n  height: 56px;\n  border: 1px solid #dadce0;\n  border-radius: 12px;\n  background: #fff;\n  padding: 0;\n  cursor: pointer;\n  overflow: hidden;\n}\n\n.palette-swatch svg {\n  display: block;\n  width: 100%;\n  height: 100%;\n}\n\n.palette-swatch-menu {\n  position: absolute;\n  min-width: 140px;\n  padding: 4px 0;\n  background: #ffffff;\n  border: 1px solid #dadce0;\n  border-radius: 10px;\n  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);\n  z-index: 30;\n  font-family: inherit;\n}\n\n.palette-swatch-menu.is-hidden {\n  display: none;\n}\n\n.palette-swatch-menu__item {\n  width: 100%;\n  border: none;\n  background: transparent;\n  padding: 8px 14px;\n  text-align: left;\n  font-size: 0.9rem;\n  cursor: pointer;\n  color: inherit;\n  line-height: 1.4;\n  transition: background 120ms ease;\n}\n\n.palette-swatch-menu__item:hover,\n.palette-swatch-menu__item:focus-visible {\n  background: rgba(99, 102, 241, 0.12);\n  outline: none;\n}\n"
  },
  "description": "",
  "createdAt": "2025-11-04T04:00:35.843Z",
  "updatedAt": "2025-11-05T06:29:55.989Z"
}

{
  "id": "select_local_file",
  "label": "Select Local File",
  "category": "Custom",
  "execution": "ui",
  "inputs": [],
  "outputs": [
    "FullName"
  ],
  "constants": [
    {
      "key": "FullName",
      "type": "TextBox",
      "value": "''"
    }
  ],
  "chainExecution": false,
  "script": "",
  "ui": {
    "markup": "<div class=\"custom-ui-node file-dialog-node\">\n  <div class=\"file-dialog-actions\">\n    <button type=\"button\" data-role=\"open\">ファイルを選択</button>\n    <button type=\"button\" data-role=\"clear\" class=\"secondary\">クリア</button>\n  </div>\n  <div class=\"file-dialog-path\" data-path>ファイルが未選択です</div>\n  <div class=\"file-dialog-status\" data-status></div>\n</div>",
    "script": "const { node, controls, updateConfig, toPowerShellLiteral, helpers, editor } = context;\nif (!controls) {\n  return;\n}\nconst openButton = controls.querySelector('[data-role=\"open\"]');\nconst clearButton = controls.querySelector('[data-role=\"clear\"]');\nconst pathLabel = controls.querySelector('[data-path]');\nconst statusLabel = controls.querySelector('[data-status]');\nconst electronAPI = editor?.electronAPI || (typeof window !== 'undefined' ? window.electronAPI : null);\nconst bridge = helpers?.NodeBridge;\nconst logger = helpers?.NodeLogger || console;\nconst statusController =\n  helpers?.NodeUI && typeof helpers.NodeUI.bindStatus === 'function'\n    ? helpers.NodeUI.bindStatus(statusLabel)\n    : null;\nlet disposed = false;\n\nconst applyStatus = (message, state = '') => {\n  if (disposed) {\n    return;\n  }\n  if (statusController) {\n    statusController.set(message, state);\n  } else if (statusLabel) {\n    statusLabel.textContent = message || '';\n    if (state) {\n      statusLabel.dataset.state = state;\n    } else {\n      delete statusLabel.dataset.state;\n    }\n  }\n};\n\nconst clearStatus = () => {\n  if (disposed) {\n    return;\n  }\n  if (statusController) {\n    statusController.clear();\n  } else if (statusLabel) {\n    statusLabel.textContent = '';\n    delete statusLabel.dataset.state;\n  }\n};\n\nconst applyPath = (rawPath, { announce = true } = {}) => {\n  if (disposed) {\n    return;\n  }\n  const value = rawPath || '';\n  updateConfig('FullName__raw', value, { silent: true });\n  updateConfig('FullName', value ? toPowerShellLiteral(value) : '', { silent: false });\n  if (pathLabel) {\n    pathLabel.textContent = value || 'ファイルが未選択です';\n    if (value) {\n      pathLabel.dataset.state = 'selected';\n    } else {\n      pathLabel.dataset.state = 'empty';\n    }\n  }\n  if (clearButton) {\n    clearButton.disabled = !value;\n  }\n  if (announce) {\n    applyStatus(value ? 'ファイルを選択しました。' : 'ファイルをクリアしました。', value ? 'success' : 'info');\n  } else {\n    clearStatus();\n  }\n};\n\napplyPath(node?.config?.FullName__raw || '', { announce: false });\n\nconst getInitialDirectory = () => {\n  const current = node?.config?.FullName__raw || '';\n  if (!current) {\n    return '';\n  }\n  const separatorIndex = Math.max(current.lastIndexOf('/'), current.lastIndexOf('\\\\'));\n  if (separatorIndex <= 0) {\n    return '';\n  }\n  return current.slice(0, separatorIndex);\n};\n\nconst openWithElectron = async () => {\n  if (!electronAPI?.selectLocalFile) {\n    return false;\n  }\n  const result = await electronAPI.selectLocalFile({\n    mode: 'file',\n    defaultPath: node?.config?.FullName__raw || undefined,\n  });\n  if (!result || result.canceled || !result.filePath) {\n    applyStatus('キャンセルしました。', 'info');\n  } else {\n    applyPath(result.filePath);\n  }\n  return true;\n};\n\nconst buildPowerShellScript = () => {\n  const lines = [\n    '$formsLoaded = [AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GetName().Name -eq \"System.Windows.Forms\" }',\n    'if (-not $formsLoaded) {',\n    '  Add-Type -AssemblyName System.Windows.Forms',\n    '}',\n    '$drawingLoaded = [AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GetName().Name -eq \"System.Drawing\" }',\n    'if (-not $drawingLoaded) {',\n    '  Add-Type -AssemblyName System.Drawing',\n    '}',\n    '$dialog = New-Object System.Windows.Forms.OpenFileDialog',\n    '$dialog.Filter = \"すべてのファイル (*.*)|*.*\"',\n  ];\n  const initialDir = getInitialDirectory();\n  if (initialDir) {\n    lines.push(`$dialog.InitialDirectory = ${toPowerShellLiteral(initialDir)}`);\n  }\n  lines.push(\n    'if ($dialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {',\n    '  @{ ok = $true; fullName = $dialog.FileName } | ConvertTo-Json -Compress',\n    '} else {',\n    '  @{ ok = $false; cancelled = $true } | ConvertTo-Json -Compress',\n    '}'\n  );\n  return lines.join('\\n');\n};\n\nconst openWithPowerShell = async () => {\n  if (!bridge?.requestJson) {\n    return false;\n  }\n  const script = buildPowerShellScript();\n  const result = await bridge.requestJson(script);\n  if (!result) {\n    throw new Error('PowerShell から応答がありません。');\n  }\n  if (result.ok && result.fullName) {\n    applyPath(result.fullName);\n  } else if (result.cancelled) {\n    applyStatus('キャンセルしました。', 'info');\n  } else {\n    throw new Error(result.error || 'ファイルを取得できませんでした。');\n  }\n  return true;\n};\n\nconst handleOpen = async () => {\n  if (disposed) {\n    return;\n  }\n  if (openButton) {\n    openButton.disabled = true;\n  }\n  applyStatus('ダイアログを開いています…', 'pending');\n  try {\n    if (await openWithElectron()) {\n      return;\n    }\n    if (await openWithPowerShell()) {\n      return;\n    }\n    applyStatus('ファイルダイアログを開けませんでした。', 'error');\n  } catch (error) {\n    applyStatus(`失敗しました: ${error?.message || error}`, 'error');\n    logger?.error?.('File selection failed', error);\n  } finally {\n    if (openButton) {\n      openButton.disabled = false;\n    }\n  }\n};\n\nconst handleClear = () => {\n  applyPath('', { announce: true });\n};\n\nopenButton?.addEventListener('click', handleOpen);\nclearButton?.addEventListener('click', handleClear);\n\nreturn () => {\n  disposed = true;\n  openButton?.removeEventListener('click', handleOpen);\n  clearButton?.removeEventListener('click', handleClear);\n  statusController?.dispose?.();\n};",
    "style": ".file-dialog-node {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n.file-dialog-actions {\n  display: flex;\n  gap: 0.5rem;\n}\n.file-dialog-actions button {\n  padding: 0.4rem 0.9rem;\n  border-radius: 0.5rem;\n  border: none;\n  cursor: pointer;\n  background: #2563eb;\n  color: #fff;\n}\n.file-dialog-actions button.secondary {\n  background: #f3f4f6;\n  color: #111827;\n}\n.file-dialog-actions button:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n.file-dialog-path {\n  min-height: 1.5rem;\n  padding: 0.35rem 0.5rem;\n  border-radius: 0.5rem;\n  background: rgba(59, 130, 246, 0.12);\n  word-break: break-all;\n  font-family: var(--font-family-mono, Consolas, 'Courier New', monospace);\n}\n.file-dialog-path[data-state='empty'] {\n  color: #6b7280;\n  background: #f9fafb;\n}\n.file-dialog-status {\n  min-height: 1.25rem;\n  font-size: 0.85rem;\n  color: #4b5563;\n}\n.file-dialog-status[data-state='success'] {\n  color: #047857;\n}\n.file-dialog-status[data-state='error'] {\n  color: #dc2626;\n}\n.file-dialog-status[data-state='pending'] {\n  color: #1d4ed8;\n}\n.file-dialog-status[data-state='info'] {\n  color: #0f172a;\n}"
  },
  "description": "PowerShell で OpenFileDialog を開き、選択したファイルのフルパスを取得して出力します。",
  "createdAt": "2024-05-10T00:00:00.000Z",
  "updatedAt": "2024-05-10T00:00:00.000Z"
}

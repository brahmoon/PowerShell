{
    "id":  "color_fill",
    "label":  "Color Fill",
    "category":  "Custom",
    "execution":  "ui",
    "inputs":  [
                   "Color",
                   "Range"
               ],
    "outputs":  [

                ],
    "constants":  [
                      {
                          "key":  "note",
                          "type":  "TextBox",
                          "value":  "# TODO: describe behavior"
                      }
                  ],
    "script":  "# Use {{input.Name}} to reference incoming values,\n# {{config.key}} for constant fields, and {{output.Result}} for outputs.\n# Remove these lines and write your PowerShell snippet here.",
    "ui":  {
               "markup":  "\u003cdiv class=\"excel-ui-node color-palette-node\" data-role=\"root\"\u003e\n  \u003cdiv class=\"palette-header\"\u003e\n    \u003cdiv class=\"palette-title\"\u003eColor Palette\u003c/div\u003e\n    \u003cdiv class=\"palette-status\" data-role=\"status\"\u003e\u003c/div\u003e\n  \u003c/div\u003e\n\n  \u003cdiv class=\"palette-frame\"\u003e\n    \u003cdiv class=\"palette-grid\" data-role=\"grid\"\u003e\n      \u003c!-- SVGボタンたちがここに挿入される（+ボタンの左に追加） --\u003e\n      \u003cbutton type=\"button\" class=\"palette-add\" data-role=\"add\" aria-label=\"Add color\"\u003e\n        \u003cspan class=\"plus-icon\"\u003e＋\u003c/span\u003e\n      \u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n",
               "script":  "const { node, controls, updateConfig, resolveInput, toPowerShellLiteral } = context;\nif (!controls) return;\n\nconst grid = controls.querySelector(\u0027[data-role=\"grid\"]\u0027);\nconst addBtn = controls.querySelector(\u0027[data-role=\"add\"]\u0027);\nconst status = controls.querySelector(\u0027[data-role=\"status\"]\u0027);\n\nconst DEFAULT_SERVER_URL = \"http://127.0.0.1:8787\";\nconst RUN_SCRIPT_PATH = \"/runScript\";\n\n/* ====== サーバ通信共通関数 ====== */\nconst normalizeServerUrl = (value) =\u003e {\n  if (!value) return \"\";\n  let url = String(value).trim();\n  if (!/^https?:\\/\\//i.test(url)) url = `http://${url}`;\n  return url.replace(/\\/+$/, \"\");\n};\nconst loadServerUrl = () =\u003e {\n  try {\n    const stored = window?.localStorage?.getItem(\"nodeflow.psServerUrl\");\n    if (stored) {\n      const normalized = normalizeServerUrl(stored);\n      return normalized || DEFAULT_SERVER_URL;\n    }\n  } catch (e) {\n    console.warn(\"Failed to load stored URL\", e);\n  }\n  return DEFAULT_SERVER_URL;\n};\nconst getRunScriptEndpoint = () =\u003e {\n  const base = normalizeServerUrl(loadServerUrl()) || DEFAULT_SERVER_URL;\n  return `${base}${RUN_SCRIPT_PATH}`;\n};\n\nconst invokePowerShell = async (script) =\u003e {\n  const endpoint = getRunScriptEndpoint();\n  const response = await fetch(endpoint, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json; charset=utf-8\" },\n    body: JSON.stringify({ script }),\n  });\n  let payload;\n  try {\n    payload = await response.json();\n  } catch {\n    throw new Error(\"PowerShell サーバーから無効な応答を受信しました。\");\n  }\n  if (!response.ok) throw new Error(payload?.error || `HTTP ${response.status}`);\n  if (payload?.ok === false) {\n    const msg = Array.isArray(payload?.errors) \u0026\u0026 payload.errors.length\n      ? payload.errors.join(\"\\n\")\n      : payload?.error || \"PowerShell がエラーを返しました。\";\n    throw new Error(msg);\n  }\n  return typeof payload?.output === \"string\" ? payload.output.trim() : \"\";\n};\n\nconst requestExcelJson = async (script) =\u003e {\n  const output = await invokePowerShell(script);\n  if (!output) return null;\n  try {\n    return JSON.parse(output);\n  } catch {\n    throw new Error(\"PowerShell の応答を解析できませんでした。\");\n  }\n};\n\n/* ====== 共通UI関数 ====== */\nconst setStatus = (message, state = \"\") =\u003e {\n  status.textContent = message || \"\";\n  status.dataset.state = state;\n};\n\n/* ====== 色ユーティリティ ====== */\nconst clamp255 = (n) =\u003e Math.max(0, Math.min(255, (n|0)));\nconst rgbToHex = (r,g,b) =\u003e \"#\" + [r,g,b].map(v=\u003ev.toString(16).padStart(2,\"0\")).join(\"\").toUpperCase();\nconst rgbToOle = (r,g,b) =\u003e r + g*256 + b*65536;\nconst hexToRgb = (hex) =\u003e {\n  const c = hex.replace(\"#\",\"\");\n  const full = c.length === 3 ? c.split(\"\").map(x=\u003ex+x).join(\"\") : c;\n  const n = parseInt(full,16);\n  return { r:(n\u003e\u003e16)\u0026255, g:(n\u003e\u003e8)\u0026255, b:n\u0026255 };\n};\nconst normalizeOneColor = (input) =\u003e {\n  if (Array.isArray(input)) {\n    const [r,g,b] = input.map(clamp255);\n    return { hex: rgbToHex(r,g,b), ole: rgbToOle(r,g,b) };\n  }\n  if (typeof input === \"string\") {\n    const s = input.trim();\n    if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(s)) {\n      const {r,g,b} = hexToRgb(s);\n      return { hex: rgbToHex(r,g,b), ole: rgbToOle(r,g,b) };\n    }\n    const m = s.match(/^rgb\\s*\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*,\\s*(\\d+)\\s*\\)$/i);\n    if (m) {\n      const r = clamp255(+m[1]), g = clamp255(+m[2]), b = clamp255(+m[3]);\n      return { hex: rgbToHex(r,g,b), ole: rgbToOle(r,g,b) };\n    }\n  }\n  throw new Error(\"Color の形式が不正です（HEX または [r,g,b]）。\");\n};\nconst parseColors = (v) =\u003e Array.isArray(v) ? v.map(normalizeOneColor) : [normalizeOneColor(v)];\n\n/* ====== SVGテンプレート ====== */\nconst SVG_TEMPLATE = `\u003csvg width=\"100%\" height=\"100%\" viewBox=\"0 0 480 480\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n\u003cpath d=\"M358.299,246.425l0,73.701l22.677,0l51.024,-48.189l0,-96.378l-25.512,-25.512l-76.535,0l62.362,62.362l-34.016,34.016Z\" style=\"fill:#5ea3d9;\"/\u003e\n\u003crect x=\"46.488\" y=\"342.803\" width=\"385.512\" height=\"90.709\" style=\"fill:#f00;\"/\u003e\n\u003c/svg\u003e`;\n\n/* ====== PowerShell スクリプト生成 ====== */\nconst COLOR_HELPERS = [\n  \"function Convert-OleToHex {\",\n  \"  param([Parameter()][object]$Ole)\",\n  \"  if ($null -eq $Ole) { return $null }\",\n  \"  try {\",\n  \"    $c = [System.Drawing.ColorTranslator]::FromOle([int]$Ole)\",\n  \"    return (\u0027#{0:X2}{1:X2}{2:X2}\u0027 -f $c.R, $c.G, $c.B)\",\n  \"  } catch { return $null }\",\n  \"}\"\n].join(\"\\n\");\n\nconst buildColorApplyScript = (rangeLiteral, colorInt) =\u003e [\n  \"$ErrorActionPreference=\u0027Stop\u0027\",\n  \"Add-Type -AssemblyName System.Drawing\",\n  COLOR_HELPERS,\n  \"$excel = [Runtime.InteropServices.Marshal]::GetActiveObject(\u0027Excel.Application\u0027)\",\n  `$target = if (${rangeLiteral} -ne \u0027\u0027) { $excel.Range(${rangeLiteral}) } else { $excel.Selection }`,\n  `if ($null -eq $target) { throw \u0027範囲が取得できません。\u0027 }`,\n  `$target.Interior.Color = ${colorInt}`,\n  \"$result = [pscustomobject]@{\",\n  \"  ok=$true;\",\n  \"  address=$target.Address();\",\n  \"  value=$target.Text;\",\n  \"  interior_color=@{ hex=Convert-OleToHex $target.Interior.Color }\",\n  \"}\",\n  \"$result | ConvertTo-Json -Compress\"\n].join(\"\\n\");\n\n/* ====== ボタン生成 ====== */\nconst createSwatchButton = (hex, ole) =\u003e {\n  const btn = document.createElement(\"button\");\n  btn.className = \"palette-swatch\";\n  btn.innerHTML = SVG_TEMPLATE.replace(/fill:#f00/gi, `fill:${hex}`);\n  btn.addEventListener(\"click\", async () =\u003e {\n    try {\n      const rangeInput = resolveInput(\"Range\", { preferRaw: true }) ?? node?.config?.Range__raw ?? \"\";\n      if (!rangeInput) throw new Error(\"Range が未指定です。\");\n\n      const rangeLiteral = toPowerShellLiteral(rangeInput);\n      const script = buildColorApplyScript(rangeLiteral, ole);\n      const data = await requestExcelJson(script);\n\n      if (!data?.ok) throw new Error(data?.error || \"PowerShell 実行に失敗しました。\");\n      setStatus(`${data.address} に色を適用しました。`, \"success\");\n    } catch (e) {\n      setStatus(`着色に失敗: ${e.message}`, \"error\");\n    }\n  });\n  return btn;\n};\n\n/* ====== 初期化 ====== */\nconst bootstrap = () =\u003e {\n  const colorInput = resolveInput(\"Color\", { preferRaw: true }) ?? node?.config?.Color__raw ?? \"#FF0000\";\n  try {\n    const colors = parseColors(colorInput);\n    colors.forEach(c =\u003e grid.insertBefore(createSwatchButton(c.hex, c.ole), addBtn));\n    setStatus(`${colors.length} 色をロードしました。`, \"info\");\n  } catch (e) {\n    setStatus(`Color の解釈に失敗: ${e.message}`, \"error\");\n  }\n};\n\n/* ====== +ボタン押下 ====== */\naddBtn.addEventListener(\"click\", () =\u003e {\n  try {\n    const colorInput = resolveInput(\"Color\", { preferRaw: true }) ?? node?.config?.Color__raw ?? \"#FF0000\";\n    const colors = parseColors(colorInput);\n    colors.forEach(c =\u003e grid.insertBefore(createSwatchButton(c.hex, c.ole), addBtn));\n    setStatus(`${colors.length} 色を追加しました。`, \"success\");\n  } catch (e) {\n    setStatus(`Color の解釈に失敗: ${e.message}`, \"error\");\n  }\n});\n\nbootstrap();\n",
               "style":  ".color-palette-node {\n  font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Noto Sans JP\", Arial, sans-serif;\n  display: grid;\n  gap: 8px;\n}\n\n.palette-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n\n.palette-title {\n  font-weight: 600;\n}\n\n.palette-status[data-state=\"error\"] { color: #b00020; }\n.palette-status[data-state=\"success\"] { color: #137333; }\n.palette-status[data-state=\"pending\"] { color: #1a73e8; }\n.palette-status[data-state=\"info\"] { color: #5f6368; }\n\n.palette-frame {\n  border: 1px solid #e0e3e7;\n  border-radius: 12px; /* 角R */\n  padding: 10px;\n  background: #fff;\n}\n\n.palette-grid {\n  display: grid;\n  grid-template-columns: repeat(6, 56px); /* 6列 */\n  gap: 8px;\n  align-items: start;\n}\n\n.palette-add {\n  width: 56px;\n  height: 56px;\n  border: 1px dashed #9aa0a6;\n  border-radius: 12px;\n  background: #f8f9fa;\n  cursor: pointer;\n  display: inline-grid;\n  place-items: center;\n}\n\n.palette-add:hover { background: #f1f3f4; }\n.plus-icon { font-size: 20px; line-height: 1; }\n\n.palette-swatch {\n  width: 56px;\n  height: 56px;\n  border: 1px solid #dadce0;\n  border-radius: 12px;\n  background: #fff;\n  padding: 0;\n  cursor: pointer;\n  overflow: hidden;\n}\n\n.palette-swatch svg {\n  display: block;\n  width: 100%;\n  height: 100%;\n}\n"
           },
    "description":  "",
    "createdAt":  "2025-11-04T04:00:35.843Z",
    "updatedAt":  "2025-11-04T04:20:40.854Z"
}
{
  "id": "color_fill",
  "label": "Color Fill",
  "category": "Custom",
  "execution": "ui",
  "inputs": [
    "Color",
    "Sheet",
    "Range"
  ],
  "outputs": [],
  "constants": [
    {
      "key": "note",
      "type": "TextBox",
      "value": "# TODO: describe behavior"
    }
  ],
  "script": "# Use {{input.Name}} to reference incoming values,\n# {{config.key}} for constant fields, and {{output.Result}} for outputs.\n# Remove these lines and write your PowerShell snippet here.",
  "ui": {
    "markup": "<div class=\"excel-ui-node color-palette-node\" data-role=\"root\">\n  <div class=\"palette-header\">\n    <div class=\"palette-title\">Color Palette</div>\n    <div class=\"palette-status\" data-role=\"status\"></div>\n  </div>\n\n  <div class=\"palette-frame\">\n    <div class=\"palette-grid\" data-role=\"grid\">\n      <!-- SVGボタンたちがここに挿入される（+ボタンの左に追加） -->\n      <button type=\"button\" class=\"palette-add\" data-role=\"add\" aria-label=\"Add color\">\n        <span class=\"plus-icon\">＋</span>\n      </button>\n    </div>\n  </div>\n</div>\n",
    "script": "const { node, controls, updateConfig, resolveInput, ensureAutoNodes, toPowerShellLiteral } = context;\nif (!controls) return;\n\nconst grid = controls.querySelector('[data-role=\"grid\"]');\nconst addBtn = controls.querySelector('[data-role=\"add\"]');\nconst status = controls.querySelector('[data-role=\"status\"]');\n\nif (!grid || !addBtn || !status) {\n  console.warn('[color_fill] Required UI elements are missing.');\n  return;\n}\n\nconst STATUS_CLASSNAMES = [\"info\", \"success\", \"error\"];\nconst setStatus = (message = \"\", state = \"\") => {\n  if (!status) {\n    return;\n  }\n  const text = typeof message === \"string\" ? message : \"\";\n  const normalized = typeof state === \"string\" ? state.trim() : \"\";\n  status.textContent = text;\n  STATUS_CLASSNAMES.forEach((name) => status.classList.remove(`is-${name}`));\n  if (normalized) {\n    status.setAttribute(\"data-state\", normalized);\n    if (STATUS_CLASSNAMES.includes(normalized)) {\n      status.classList.add(`is-${normalized}`);\n    }\n  } else {\n    status.removeAttribute(\"data-state\");\n  }\n};\n\nconst DEFAULT_SERVER_URL = \"http://127.0.0.1:8787\";\nconst RUN_SCRIPT_PATH = \"/runScript\";\n\nconst swatchSet = new Set();\nconst paletteMap = new Map();\nconst PALETTE_CONFIG_KEY = \"colorPalette\";\nlet swatchMenu = null;\nlet swatchMenuTargetKey = null;\nconst root = controls.querySelector('[data-role=\"root\"]') || controls;\n\nconst ensureSwatchMenu = () => {\n  if (swatchMenu) {\n    return swatchMenu;\n  }\n  if (!root) {\n    return null;\n  }\n  const menu = document.createElement(\"div\");\n  menu.className = \"palette-swatch-menu is-hidden\";\n  menu.tabIndex = -1;\n  menu.addEventListener(\"contextmenu\", (event) => event.preventDefault());\n  menu.addEventListener(\"pointerdown\", (event) => event.stopPropagation());\n  const deleteBtn = document.createElement(\"button\");\n  deleteBtn.type = \"button\";\n  deleteBtn.className = \"palette-swatch-menu__item\";\n  deleteBtn.textContent = \"削除\";\n  deleteBtn.addEventListener(\"click\", () => {\n    if (!swatchMenuTargetKey) {\n      return;\n    }\n    const removed = removeSwatchByKey(swatchMenuTargetKey);\n    hideSwatchMenu();\n    if (removed) {\n      setStatus(`${removed.hex} を削除しました。`, \"info\");\n    }\n  });\n  menu.appendChild(deleteBtn);\n  root.appendChild(menu);\n  swatchMenu = menu;\n  return menu;\n};\n\nconst hideSwatchMenu = () => {\n  if (!swatchMenu) {\n    return;\n  }\n  if (!swatchMenu.classList.contains(\"is-hidden\")) {\n    swatchMenu.classList.add(\"is-hidden\");\n  }\n  swatchMenuTargetKey = null;\n};\n\nconst persistPalette = ({ silent = false } = {}) => {\n  const payload = Array.from(paletteMap.values()).filter((item) => {\n    const hex = typeof item?.hex === \"string\" ? item.hex.trim() : \"\";\n    const hasOle = item?.ole !== undefined && item?.ole !== null;\n    return hex && hasOle;\n  });\n  const serialized = payload.length ? JSON.stringify(payload) : \"\";\n  updateConfig(PALETTE_CONFIG_KEY, serialized, { silent });\n};\n\nconst clearSwatches = ({ persist = false, silent = false } = {}) => {\n  grid.querySelectorAll('.palette-swatch').forEach((node) => node.remove());\n  swatchSet.clear();\n  paletteMap.clear();\n  hideSwatchMenu();\n  if (persist) {\n    persistPalette({ silent });\n  }\n};\n\nconst removeSwatchByKey = (key) => {\n  if (key === undefined || key === null) {\n    return null;\n  }\n  const stringKey = String(key);\n  const entry = paletteMap.get(stringKey);\n  if (!entry) {\n    return null;\n  }\n  const swatch = grid.querySelector(`.palette-swatch[data-key=\"${stringKey}\"]`);\n  if (swatch) {\n    swatch.remove();\n  }\n  swatchSet.delete(stringKey);\n  paletteMap.delete(stringKey);\n  persistPalette();\n  return entry;\n};\n\nconst openSwatchMenu = (event, key) => {\n  event.preventDefault();\n  event.stopPropagation();\n  const menu = ensureSwatchMenu();\n  if (!menu || !root) {\n    return;\n  }\n  swatchMenuTargetKey = key;\n  menu.classList.remove(\"is-hidden\");\n  menu.style.left = \"0px\";\n  menu.style.top = \"0px\";\n  const rootRect = root.getBoundingClientRect();\n  const menuRect = menu.getBoundingClientRect();\n  let left = event.clientX - rootRect.left;\n  let top = event.clientY - rootRect.top;\n  if (Number.isFinite(menuRect.width) && Number.isFinite(rootRect.width)) {\n    const maxLeft = Math.max(0, rootRect.width - menuRect.width - 4);\n    left = Math.max(4, Math.min(left, maxLeft));\n  }\n  if (Number.isFinite(menuRect.height) && Number.isFinite(rootRect.height)) {\n    const maxTop = Math.max(0, rootRect.height - menuRect.height - 4);\n    top = Math.max(4, Math.min(top, maxTop));\n  }\n  menu.style.left = `${left}px`;\n  menu.style.top = `${top}px`;\n  menu.focus({ preventScroll: true });\n};\n\nconst createSwatchButton = (hex, ole) => {\n  const key = String(ole);\n  const btn = document.createElement(\"button\");\n  btn.type = \"button\";\n  btn.className = \"palette-swatch\";\n  btn.dataset.hex = hex;\n  btn.dataset.ole = String(ole);\n  btn.dataset.key = key;\n  btn.setAttribute(\"aria-label\", `${hex} を適用`);\n  btn.setAttribute(\"title\", hex);\n  btn.innerHTML = SVG_TEMPLATE.replace(/fill:#f00/gi, `fill:${hex}`);\n\n  btn.addEventListener(\"click\", async () => {\n    hideSwatchMenu();\n    btn.disabled = true;\n    try {\n      setStatus(`${hex} を適用中…`, \"pending\");\n      const rangeValue = await getPortValue(\"Range\");\n      const sheetInput = await getPortValue(\"Sheet\");\n      const rangeInfo = parseRangeInfo(rangeValue);\n      const sheetInfo = parseSheetPort(sheetInput);\n      if (sheetInfo.sheet && !rangeInfo.sheet) {\n        rangeInfo.sheet = sheetInfo.sheet;\n      }\n      if (sheetInfo.workbook && !rangeInfo.workbook) {\n        rangeInfo.workbook = sheetInfo.workbook;\n      }\n      const rangeSpec = {\n        addressLiteral: rangeInfo.address ? toPowerShellLiteral(rangeInfo.address) : null,\n        workbookLiteral: rangeInfo.workbook ? toPowerShellLiteral(rangeInfo.workbook) : null,\n        sheetLiteral: rangeInfo.sheet ? toPowerShellLiteral(rangeInfo.sheet) : null,\n      };\n      const script = buildColorApplyScript(rangeSpec, ole);\n      const data = await requestExcelJson(script);\n      if (!data?.ok) {\n        throw new Error(data?.error || \"PowerShell 実行に失敗しました。\");\n      }\n      const labelParts = [data.workbook, data.sheet, data.address].filter(Boolean);\n      const label = labelParts.length ? labelParts.join(\" \") : \"選択範囲\";\n      setStatus(`${label} に色を適用しました。`, \"success\");\n    } catch (error) {\n      setStatus(`着色に失敗: ${error.message}`, \"error\");\n    } finally {\n      btn.disabled = false;\n    }\n  });\n\n  btn.addEventListener(\"contextmenu\", (event) => {\n    openSwatchMenu(event, key);\n  });\n\n  return btn;\n};\n\nconst applyColors = (colors, { replace = false, persist = true, silentPersist = false } = {}) => {\n  const list = Array.isArray(colors) ? colors : [];\n  if (replace) {\n    clearSwatches({ persist: false });\n  }\n  let added = 0;\n  for (const item of list) {\n    if (!item) {\n      continue;\n    }\n    const hex = typeof item.hex === \"string\" ? item.hex.trim() : \"\";\n    const ole = item.ole;\n    const hasOle = ole !== undefined && ole !== null;\n    if (!hex || !hasOle) {\n      continue;\n    }\n    const key = String(ole);\n    if (swatchSet.has(key)) {\n      continue;\n    }\n    const swatch = createSwatchButton(hex, ole);\n    grid.insertBefore(swatch, addBtn);\n    swatchSet.add(key);\n    paletteMap.set(key, { hex, ole });\n    added += 1;\n  }\n  if (persist && (replace || added)) {\n    persistPalette({ silent: silentPersist });\n  }\n  return { added, total: list.length };\n};\n\nconst addColorsFromInput = (rawValue, { replace = false, persist = true, silentPersist = false } = {}) => {\n  if (isEmptyValue(rawValue)) {\n    if (replace) {\n      clearSwatches({ persist, silent: silentPersist });\n    }\n    return { added: 0, total: 0 };\n  }\n  const colors = parseColors(rawValue);\n  return applyColors(colors, { replace, persist, silentPersist });\n};\n\nconst loadStoredPalette = () => {\n  const raw = node?.config?.[PALETTE_CONFIG_KEY];\n  if (typeof raw !== \"string\") {\n    return [];\n  }\n  const trimmed = raw.trim();\n  if (!trimmed) {\n    return [];\n  }\n  try {\n    const parsed = JSON.parse(trimmed);\n    if (!Array.isArray(parsed)) {\n      return [];\n    }\n    return parsed\n      .map((item) => {\n        if (!item) {\n          return null;\n        }\n        const hex = typeof item.hex === \"string\" ? item.hex.trim() : \"\";\n        const ole = item.ole;\n        const hasOle = ole !== undefined && ole !== null;\n        if (!hex || !hasOle) {\n          return null;\n        }\n        return { hex, ole };\n      })\n      .filter(Boolean);\n  } catch (error) {\n    console.warn('[color_fill] Failed to parse stored palette', error);\n    return [];\n  }\n};\n\nconst documentPointerDownHandler = (event) => {\n  if (!swatchMenu || swatchMenu.classList.contains(\"is-hidden\")) {\n    return;\n  }\n  const target = event.target;\n  if (!target || !(target instanceof Node)) {\n    hideSwatchMenu();\n    return;\n  }\n  if (swatchMenu.contains(target)) {\n    return;\n  }\n  if (!root.contains(target) || event.button !== 2) {\n    hideSwatchMenu();\n  }\n};\n\nconst documentKeydownHandler = (event) => {\n  if (event.key === \"Escape\") {\n    hideSwatchMenu();\n  }\n};\n\nconst documentScrollHandler = () => {\n  hideSwatchMenu();\n};\n\ndocument.addEventListener(\"pointerdown\", documentPointerDownHandler);\ndocument.addEventListener(\"keydown\", documentKeydownHandler);\ndocument.addEventListener(\"scroll\", documentScrollHandler, true);\n/* ====== 初期化 ====== */\nconst bootstrap = async () => {\n  const restored = loadStoredPalette();\n  let restoredCount = 0;\n  if (restored.length) {\n    const { added } = applyColors(restored, { replace: true, persist: false });\n    restoredCount = added;\n    if (added) {\n      setStatus(`${added} 色を復元しました。`, \"info\");\n    }\n  }\n  try {\n    const colorInput = await getPortValue(\"Color\");\n    const fallback = restoredCount ? \"\" : \"#FF0000\";\n    const source = !isEmptyValue(colorInput) ? colorInput : fallback;\n    if (!source) {\n      if (!restoredCount) {\n        setStatus(\"Color ポートに色を指定してください。\", \"info\");\n      }\n      return;\n    }\n    const { added, total } = addColorsFromInput(source, {\n      replace: restoredCount === 0,\n    });\n    if (added) {\n      setStatus(\n        restoredCount ? `${added} 色を追加しました。` : `${added} 色をロードしました。`,\n        restoredCount ? \"success\" : \"info\"\n      );\n    } else if (total) {\n      if (restoredCount) {\n        setStatus(\"既存のパレットと同じ色のみが検出されました。\", \"info\");\n      } else {\n        setStatus(\"すべて既に追加済みの色です。\", \"info\");\n      }\n    }\n  } catch (error) {\n    clearSwatches({ persist: true });\n    setStatus(`Color の解釈に失敗: ${error.message}`, \"error\");\n  }\n};\n\n/* ====== +ボタン押下 ====== */\naddBtn.addEventListener(\"click\", async () => {\n  hideSwatchMenu();\n  try {\n    const colorInput = await getPortValue(\"Color\");\n    const { added, total } = addColorsFromInput(colorInput || \"#FF0000\");\n    if (added) {\n      setStatus(`${added} 色を追加しました。`, \"success\");\n    } else if (total) {\n      setStatus(\"すべて既に追加済みの色です。\", \"info\");\n    }\n  } catch (error) {\n    setStatus(`Color の解釈に失敗: ${error.message}`, \"error\");\n  }\n});\n\nbootstrap();\n\nreturn () => {\n  document.removeEventListener(\"pointerdown\", documentPointerDownHandler);\n  document.removeEventListener(\"keydown\", documentKeydownHandler);\n  document.removeEventListener(\"scroll\", documentScrollHandler, true);\n  hideSwatchMenu();\n  if (swatchMenu) {\n    swatchMenu.remove();\n    swatchMenu = null;\n  }\n  swatchMenuTargetKey = null;\n  swatchSet.clear();\n  paletteMap.clear();\n};\n",
    "style": ".color-palette-node {\n  font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Noto Sans JP\", Arial, sans-serif;\n  display: grid;\n  gap: 8px;\n  position: relative;\n}\n\n.palette-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n\n.palette-title {\n  font-weight: 600;\n}\n\n.palette-status[data-state=\"error\"] { color: #b00020; }\n.palette-status[data-state=\"success\"] { color: #137333; }\n.palette-status[data-state=\"pending\"] { color: #1a73e8; }\n.palette-status[data-state=\"info\"] { color: #5f6368; }\n\n.palette-frame {\n  border: 1px solid #e0e3e7;\n  border-radius: 12px; /* 角R */\n  padding: 10px;\n  background: #fff;\n}\n\n.palette-grid {\n  display: grid;\n  grid-template-columns: repeat(6, 56px); /* 6列 */\n  gap: 8px;\n  align-items: start;\n}\n\n.palette-add {\n  width: 56px;\n  height: 56px;\n  border: 1px dashed #9aa0a6;\n  border-radius: 12px;\n  background: #f8f9fa;\n  cursor: pointer;\n  display: inline-grid;\n  place-items: center;\n}\n\n.palette-add:hover { background: #f1f3f4; }\n.plus-icon { font-size: 20px; line-height: 1; }\n\n.palette-swatch {\n  width: 56px;\n  height: 56px;\n  border: 1px solid #dadce0;\n  border-radius: 12px;\n  background: #fff;\n  padding: 0;\n  cursor: pointer;\n  overflow: hidden;\n}\n\n.palette-swatch svg {\n  display: block;\n  width: 100%;\n  height: 100%;\n}\n\n.palette-swatch-menu {\n  position: absolute;\n  min-width: 140px;\n  padding: 4px 0;\n  background: #ffffff;\n  border: 1px solid #dadce0;\n  border-radius: 10px;\n  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);\n  z-index: 30;\n  font-family: inherit;\n}\n\n.palette-swatch-menu.is-hidden {\n  display: none;\n}\n\n.palette-swatch-menu__item {\n  width: 100%;\n  border: none;\n  background: transparent;\n  padding: 8px 14px;\n  text-align: left;\n  font-size: 0.9rem;\n  cursor: pointer;\n  color: inherit;\n  line-height: 1.4;\n  transition: background 120ms ease;\n}\n\n.palette-swatch-menu__item:hover,\n.palette-swatch-menu__item:focus-visible {\n  background: rgba(99, 102, 241, 0.12);\n  outline: none;\n}\n"
  },
  "description": "",
  "createdAt": "2025-11-04T04:00:35.843Z",
  "updatedAt": "2025-11-04T05:36:01.720Z"
}
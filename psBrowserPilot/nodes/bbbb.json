{
    "id":  "bbbb",
    "label":  "Sample UI: Excel Workbook Selector",
    "category":  "Custom",
    "execution":  "ui",
    "inputs":  [

               ],
    "outputs":  [
                    "WorkbookName"
                ],
    "constants":  [

                  ],
    "script":  "",
    "ui":  {
               "markup":  "\u003cdiv class=\"excel-ui-node workbook-selector-node\" data-role=\"root\"\u003e\n  \u003cdiv class=\"excel-ui-row\"\u003e\n    \u003cselect class=\"excel-ui-select\" data-role=\"workbook\"\u003e\u003c/select\u003e\n    \u003cbutton type=\"button\" class=\"excel-ui-button\" data-role=\"refresh\"\u003e更新\u003c/button\u003e\n  \u003c/div\u003e\n  \u003cdiv class=\"excel-ui-status\" data-role=\"status\"\u003e\u003c/div\u003e\n\u003c/div\u003e",
               "script":  "const { node, controls, updateConfig, toPowerShellLiteral } = context;\nif (!controls) return;\nconst select = controls.querySelector(\u0027[data-role=\"workbook\"]\u0027);\nconst refreshBtn = controls.querySelector(\u0027[data-role=\"refresh\"]\u0027);\nconst status = controls.querySelector(\u0027[data-role=\"status\"]\u0027);\nconst DEFAULT_SERVER_URL = \u0027http://127.0.0.1:8787\u0027;\nconst RUN_SCRIPT_PATH = \u0027/runScript\u0027;\n// --- Utility ---\nconst normalizeServerUrl = (value) =\u003e {\n  if (!value) return \u0027\u0027;\n  let url = String(value).trim();\n  if (!/^https?:\\/\\//i.test(url)) url = `http://${url}`;\n  return url.replace(/\\/+$/, \u0027\u0027);\n};\nconst loadServerUrl = () =\u003e {\n  try {\n    const stored = window?.localStorage?.getItem(\u0027nodeflow.psServerUrl\u0027);\n    if (stored) return normalizeServerUrl(stored) || DEFAULT_SERVER_URL;\n  } catch (err) {\n    console.warn(\u0027Failed to read stored server URL\u0027, err);\n  }\n  return DEFAULT_SERVER_URL;\n};\nconst getRunScriptEndpoint = () =\u003e {\n  const base = normalizeServerUrl(loadServerUrl()) || DEFAULT_SERVER_URL;\n  return `${base}${RUN_SCRIPT_PATH}`;\n};\n// --- Fetch wrapper ---\nconst invokePowerShell = async (script) =\u003e {\n  const endpoint = getRunScriptEndpoint();\n  const response = await fetch(endpoint, {\n    method: \u0027POST\u0027,\n    headers: { \u0027Content-Type\u0027: \u0027application/json; charset=utf-8\u0027 },\n    body: JSON.stringify({ script }),\n  });\n  let payload;\n  try {\n    payload = await response.json();\n  } catch {\n    throw new Error(\u0027PowerShell サーバーから無効な応答を受信しました。\u0027);\n  }\n  if (!response.ok) {\n    const msg = payload?.error || `HTTP ${response.status}`;\n    throw new Error(msg);\n  }\n  if (payload?.ok === false) {\n    const msg = Array.isArray(payload?.errors) \u0026\u0026 payload.errors.length\n      ? payload.errors.join(\u0027\\n\u0027)\n      : payload?.error || \u0027PowerShell がエラーを返しました。\u0027;\n    throw new Error(msg);\n  }\n  if (typeof payload?.output === \u0027string\u0027) return payload.output.trim();\n  if (typeof payload === \u0027string\u0027) return payload.trim();\n  return \u0027\u0027;\n};\n// --- JSON helper (robust parser) ---\nconst requestExcelJson = async (script) =\u003e {\n  const output = await invokePowerShell(script);\n  if (!output) return null;\n  const clean = output.replace(/^[\\uFEFF\\s\\r\\n]+/, \u0027\u0027).replace(/[\\s\\r\\n]+$/, \u0027\u0027);\n  const start = clean.indexOf(\u0027{\u0027);\n  const end = clean.lastIndexOf(\u0027}\u0027);\n  if (start === -1 || end === -1 || end \u003c= start) {\n    console.warn(\u0027JSON not found in PowerShell output:\u0027, clean);\n    throw new Error(\u0027PowerShell の応答を解析できませんでした。\u0027);\n  }\n  const jsonText = clean.slice(start, end + 1);\n  try {\n    return JSON.parse(jsonText);\n  } catch (error) {\n    console.error(\u0027JSON parse failed:\u0027, error, jsonText);\n    throw new Error(\u0027PowerShell の応答を解析できませんでした。\u0027);\n  }\n};\n// --- PowerShell Script to list Excel workbooks ---\nconst LIST_WORKBOOKS_SCRIPT = [\n  \"$ErrorActionPreference = \u0027Stop\u0027\",\n  \u0027$excel = $null\u0027,\n  \u0027$workbook = $null\u0027,\n  \u0027$sheet = $null\u0027,\n  \u0027$workbooks = $null\u0027,\n  \u0027$result = $null\u0027,\n  \u0027\u0027,\n  \u0027try {\u0027,\n  \u0027  try { $excel = [Runtime.Interopservices.Marshal]::GetActiveObject(\"Excel.Application\") } catch { $excel = $null }\u0027,\n  \u0027  if (-not $excel) {\u0027,\n  \u0027    $result = [pscustomobject]@{ ok = $false; error = \"Excel が見つかりません。\"; workbooks = @() }\u0027,\n  \u0027  } else {\u0027,\n  \u0027    $names = @()\u0027,\n  \u0027    foreach ($wb in @($excel.Workbooks)) { if ($null -ne $wb) { $names += [string]$wb.Name } }\u0027,\n  \u0027    $result = [pscustomobject]@{ ok = $true; workbooks = $names }\u0027,\n  \u0027  }\u0027,\n  \u0027} catch {\u0027,\n  \u0027  $result = [pscustomobject]@{ ok = $false; error = $_.Exception.Message; workbooks = @() }\u0027,\n  \u0027} finally {\u0027,\n  \u0027  if ($workbooks -ne $null) {\u0027,\n  \u0027    foreach ($wb in @($workbooks)) { if ($null -ne $wb) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($wb) | Out-Null } }\u0027,\n  \u0027    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbooks) | Out-Null\u0027,\n  \u0027  }\u0027,\n  \u0027  if ($sheet -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($sheet) | Out-Null }\u0027,\n  \u0027  if ($workbook -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null }\u0027,\n  \u0027  if ($excel -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null }\u0027,\n  \u0027  [GC]::Collect(); [GC]::WaitForPendingFinalizers()\u0027,\n  \u0027}\u0027,\n  \u0027$result | ConvertTo-Json -Compress\u0027\n].join(\u0027\\n\u0027);\n// --- UI binding ---\nif (!select || !refreshBtn || !status) return;\nlet disposed = false;\nconst setStatus = (msg, state = \u0027\u0027) =\u003e {\n  if (disposed) return;\n  status.textContent = msg || \u0027\u0027;\n  status.dataset.state = state;\n};\nconst applySelection = (workbookName) =\u003e {\n  const raw = workbookName || \u0027\u0027;\n  const literal = raw ? toPowerShellLiteral(raw) : \u0027\u0027;\n  updateConfig(\u0027WorkbookName__raw\u0027, raw, { silent: true });\n  updateConfig(\u0027WorkbookName\u0027, literal, { silent: true });\n  updateConfig(\u0027selectedWorkbookLabel\u0027, raw, { silent: false });\n};\nconst populateOptions = (items, { preserveSelection = true } = {}) =\u003e {\n  select.innerHTML = \u0027\u0027;\n  const placeholder = document.createElement(\u0027option\u0027);\n  placeholder.value = \u0027\u0027;\n  placeholder.textContent = items.length ? \u0027ブックを選択\u0027 : \u0027ブックが見つかりません\u0027;\n  placeholder.disabled = true;\n  placeholder.selected = true;\n  select.appendChild(placeholder);\n  items.forEach((item) =\u003e {\n    const opt = document.createElement(\u0027option\u0027);\n    opt.value = item;\n    opt.textContent = item;\n    select.appendChild(opt);\n  });\n  if (preserveSelection) {\n    const stored = node?.config?.WorkbookName__raw || node?.config?.selectedWorkbookLabel;\n    if (stored \u0026\u0026 items.includes(stored)) select.value = stored;\n  }\n  select.disabled = !items.length;\n};\nconst fetchWorkbooks = async () =\u003e {\n  setStatus(\u0027Excelのブックを取得中…\u0027, \u0027pending\u0027);\n  refreshBtn.disabled = true;\n  try {\n    const data = await requestExcelJson(LIST_WORKBOOKS_SCRIPT);\n    if (disposed) return;\n    if (!data?.ok) throw new Error(data?.error || \u0027ブック情報を取得できませんでした\u0027);\n    const workbooks = Array.isArray(data.workbooks) ? data.workbooks : [];\n    populateOptions(workbooks);\n    if (workbooks.length) setStatus(`${workbooks.length} 件のブックを検出しました。`, \u0027success\u0027);\n    else setStatus(\u0027開いているブックが見つかりません。\u0027, \u0027info\u0027);\n  } catch (err) {\n    console.error(\u0027Workbook fetch failed:\u0027, err);\n    populateOptions([], { preserveSelection: false });\n    setStatus(`取得に失敗しました: ${err.message}`, \u0027error\u0027);\n  } finally {\n    if (!disposed) refreshBtn.disabled = false;\n  }\n};\nconst handleChange = (e) =\u003e {\n  const value = e.target.value || \u0027\u0027;\n  applySelection(value);\n  setStatus(value ? `${value} を選択しました。` : \u0027\u0027, value ? \u0027success\u0027 : \u0027info\u0027);\n};\nconst handleRefresh = (e) =\u003e {\n  e.preventDefault();\n  fetchWorkbooks();\n};\nselect.addEventListener(\u0027change\u0027, handleChange);\nrefreshBtn.addEventListener(\u0027click\u0027, handleRefresh);\npopulateOptions([], { preserveSelection: true });\nconst stored = node?.config?.selectedWorkbookLabel || node?.config?.WorkbookName__raw || \u0027\u0027;\nif (stored) setStatus(`${stored} を再選択できます。`, \u0027info\u0027);\nfetchWorkbooks();\nreturn () =\u003e {\n  disposed = true;\n  select.removeEventListener(\u0027change\u0027, handleChange);\n  refreshBtn.removeEventListener(\u0027click\u0027, handleRefresh);\n};",
               "style":  ".excel-ui-node {\n  display: grid;\n  gap: 0.6rem;\n  font-size: 0.9rem;\n}\n.excel-ui-row {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n.excel-ui-select {\n  flex: 1;\n  border: 1px solid var(--border);\n  border-radius: 8px;\n  padding: 0.45rem 0.6rem;\n  background: var(--panel-subtle);\n  font-size: 0.9rem;\n  color: var(--text);\n}\n.excel-ui-button {\n  border: none;\n  border-radius: 999px;\n  padding: 0.45rem 0.9rem;\n  font-weight: 600;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;\n  background: rgba(37, 99, 235, 0.18);\n  color: #1d4ed8;\n}\n.excel-ui-button:hover:not(:disabled),\n.excel-ui-button:focus-visible:not(:disabled) {\n  transform: translateY(-1px);\n  box-shadow: 0 6px 18px rgba(37, 99, 235, 0.28);\n}\n.excel-ui-button:disabled {\n  opacity: 0.55;\n  cursor: not-allowed;\n  transform: none;\n  box-shadow: none;\n}\n.excel-ui-status {\n  min-height: 1.1em;\n  font-size: 0.8rem;\n  color: var(--muted);\n}\n.excel-ui-status[data-state=\u0027success\u0027] {\n  color: #1f9d72;\n}\n.excel-ui-status[data-state=\u0027error\u0027] {\n  color: #dc2626;\n}\n.excel-ui-status[data-state=\u0027pending\u0027] {\n  color: #2563eb;\n}"
           },
    "description":  "",
    "createdAt":  "2025-11-04T03:03:53.437Z",
    "updatedAt":  "2025-11-04T03:03:53.438Z"
}
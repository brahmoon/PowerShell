{
  "id": "bbbb",
  "label": "Sample UI: Excel Workbook Selector",
  "category": "Custom",
  "execution": "ui",
  "inputs": [],
  "outputs": [
    "WorkbookName"
  ],
  "constants": [],
  "script": "",
  "ui": {
    "markup": "<div class=\"excel-ui-node workbook-selector-node\" data-role=\"root\">\n  <div class=\"excel-ui-row\">\n    <select class=\"excel-ui-select\" data-role=\"workbook\"></select>\n    <button type=\"button\" class=\"excel-ui-button\" data-role=\"refresh\">更新</button>\n  </div>\n  <div class=\"excel-ui-status\" data-role=\"status\"></div>\n</div>",
    "script": "const { node, controls, updateConfig, toPowerShellLiteral, helpers } = context;\nif (!controls) return;\n\nconst select = controls.querySelector('[data-role=\"workbook\"]');\nconst refreshBtn = controls.querySelector('[data-role=\"refresh\"]');\nconst statusEl = controls.querySelector('[data-role=\"status\"]');\nif (!select || !refreshBtn || !statusEl) {\n  helpers?.NodeLogger?.warn?.('[workbook_selector] Required UI elements are missing.');\n  return;\n}\n\nconst status = helpers?.NodeUI?.bindStatus(statusEl);\nconst bridge = helpers?.NodeBridge;\nconst logger = helpers?.NodeLogger || console;\n\nconst LIST_WORKBOOKS_SCRIPT = [\n  \"$ErrorActionPreference = 'Stop'\",\n  '$excel = $null',\n  '$workbooks = $null',\n  '$result = $null',\n  'try {',\n  \"  $excel = [Runtime.Interopservices.Marshal]::GetActiveObject('Excel.Application')\",\n  '  if (-not $excel) {',\n  \"    throw 'Excel が見つかりません。'\",\n  '  }',\n  '  $workbooks = $excel.Workbooks',\n  '  $names = @()',\n  '  foreach ($wb in @($workbooks)) { if ($null -ne $wb) { $names += [string]$wb.Name } }',\n  '  $result = [pscustomobject]@{ ok = $true; workbooks = $names }',\n  '} catch {',\n  '  $result = [pscustomobject]@{ ok = $false; error = $_.Exception.Message; workbooks = @() }',\n  '} finally {',\n  '  if ($workbooks -ne $null) {',\n  '    foreach ($wb in @($workbooks)) { if ($null -ne $wb) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($wb) | Out-Null } }',\n  '    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbooks) | Out-Null',\n  '  }',\n  \"  if ($excel -ne $null) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null }\",\n  '  [GC]::Collect(); [GC]::WaitForPendingFinalizers()',\n  '}',\n  '$result | ConvertTo-Json -Compress',\n].join('\\n');\n\nconst applySelection = (workbookName) => {\n  const raw = workbookName || '';\n  const literal = raw ? toPowerShellLiteral(raw) : '';\n  updateConfig('WorkbookName__raw', raw, { silent: true });\n  updateConfig('WorkbookName', literal, { silent: true });\n  updateConfig('selectedWorkbookLabel', raw, { silent: false });\n};\n\nconst populateOptions = (items, { preserveSelection = true } = {}) => {\n  select.innerHTML = '';\n  const placeholder = document.createElement('option');\n  placeholder.value = '';\n  placeholder.textContent = items.length ? 'ブックを選択' : 'ブックが見つかりません';\n  placeholder.disabled = true;\n  placeholder.selected = true;\n  select.appendChild(placeholder);\n  items.forEach((item) => {\n    const option = document.createElement('option');\n    option.value = item;\n    option.textContent = item;\n    select.appendChild(option);\n  });\n  if (preserveSelection) {\n    const stored = node?.config?.WorkbookName__raw || node?.config?.selectedWorkbookLabel;\n    if (stored && items.includes(stored)) {\n      select.value = stored;\n    }\n  }\n  select.disabled = !items.length;\n};\n\nconst fetchWorkbooks = async () => {\n  status?.set?.('Excelのブックを取得中…', 'pending');\n  refreshBtn.disabled = true;\n  try {\n    if (!bridge?.requestJson) {\n      throw new Error('PowerShell ブリッジが利用できません。');\n    }\n    const data = await bridge.requestJson(LIST_WORKBOOKS_SCRIPT);\n    if (!data?.ok) {\n      throw new Error(data?.error || 'ブック情報を取得できませんでした');\n    }\n    const workbooks = Array.isArray(data.workbooks) ? data.workbooks : [];\n    populateOptions(workbooks);\n    if (workbooks.length) {\n      status?.set?.(`${workbooks.length} 件のブックを検出しました。`, 'success');\n    } else {\n      status?.set?.('開いているブックが見つかりません。', 'info');\n    }\n  } catch (error) {\n    populateOptions([], { preserveSelection: false });\n    const message = error?.message || 'ブック情報を取得できませんでした';\n    status?.set?.(`取得に失敗しました: ${message}`, 'error');\n    logger?.error?.('[workbook_selector] Failed to fetch workbooks', error);\n  } finally {\n    refreshBtn.disabled = false;\n  }\n};\n\nselect.addEventListener('change', (event) => {\n  const value = event.currentTarget.value;\n  applySelection(value);\n  if (value) {\n    status?.set?.(`${value} を選択しました。`, 'success');\n  } else {\n    status?.set?.('ブックを選択してください。', 'info');\n  }\n});\n\nrefreshBtn.addEventListener('click', (event) => {\n  event.preventDefault();\n  fetchWorkbooks();\n});\n\nconst stored = node?.config?.selectedWorkbookLabel || node?.config?.WorkbookName__raw || '';\nif (stored) {\n  populateOptions([stored], { preserveSelection: true });\n  applySelection(stored);\n  status?.set?.(`${stored} を再選択できます。`, 'info');\n} else {\n  populateOptions([], { preserveSelection: false });\n  status?.set?.('ブックを選択してください。', 'info');\n}\n\nfetchWorkbooks();\n\nreturn () => {\n  status?.dispose?.();\n};",
    "style": ".excel-ui-node {\n  display: grid;\n  gap: 0.6rem;\n  font-size: 0.9rem;\n}\n.excel-ui-row {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n.excel-ui-select {\n  flex: 1;\n  border: 1px solid var(--border);\n  border-radius: 8px;\n  padding: 0.45rem 0.6rem;\n  background: var(--panel-subtle);\n  font-size: 0.9rem;\n  color: var(--text);\n}\n.excel-ui-button {\n  border: none;\n  border-radius: 999px;\n  padding: 0.45rem 0.9rem;\n  font-weight: 600;\n  cursor: pointer;\n  transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;\n  background: rgba(37, 99, 235, 0.18);\n  color: #1d4ed8;\n}\n.excel-ui-button:hover:not(:disabled),\n.excel-ui-button:focus-visible:not(:disabled) {\n  transform: translateY(-1px);\n  box-shadow: 0 6px 18px rgba(37, 99, 235, 0.28);\n}\n.excel-ui-button:disabled {\n  opacity: 0.55;\n  cursor: not-allowed;\n  transform: none;\n  box-shadow: none;\n}\n.excel-ui-status {\n  min-height: 1.1em;\n  font-size: 0.8rem;\n  color: var(--muted);\n}\n.excel-ui-status[data-state='success'] {\n  color: #1f9d72;\n}\n.excel-ui-status[data-state='error'] {\n  color: #dc2626;\n}\n.excel-ui-status[data-state='pending'] {\n  color: #2563eb;\n}"
  },
  "description": "",
  "createdAt": "2025-11-04T03:03:53.437Z",
  "updatedAt": "2025-11-04T03:03:53.438Z"
}
